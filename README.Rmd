---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# creditools

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![R-CMD-check](https://github.com/matheuspasche/creditools/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/matheuspasche/creditools/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

The goal of `creditools` is to provide a flexible and powerful framework for simulating and analyzing credit policies. It allows risk analysts to model multi-stage decision funnels, simulate the impact of new strategies (e.g., changing score cutoffs), and analyze the trade-off between business metrics (like approval rate) and risk metrics (like default rate) under various stress scenarios.

## Installation

You can install the development version of creditools from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("matheuspasche/creditools")
```

## Core Concepts

The package is built around three main ideas:

1.  **`credit_policy()`**: A central object that holds all the configuration for a simulation: column mappings, the sequence of decision stages, and stress scenarios for default simulation.
2.  **`stages`**: A policy is composed of sequential stages, such as `stage_cutoff()` (for score-based decisions) or `stage_rate()` (for probabilistic stages like fraud checks or conversion rates).
3.  **`run_simulation()` / `run_tradeoff_analysis()`**: The simulation engines. `run_simulation()` executes a single, defined policy, while `run_tradeoff_analysis()` is a powerful wrapper that runs dozens or hundreds of simulations to explore the impact of varying parameters.

## A Complete Example

Here is a quick walk-through of the main workflow.

### 1. Load Package and Generate Data

First, we'll generate a sample dataset. `creditools` provides a handy function for this.

```{r example-setup, message=FALSE, warning=FALSE}
library(creditools)
library(dplyr)
library(ggplot2)

sample_data <- generate_sample_data(n_applicants = 20000, seed = 42)
sample_data$new_score_decile <- dplyr::ntile(sample_data$new_score, 10)
```

### 2. Define and Run a Trade-off Analysis

Let's analyze the impact of switching to `new_score`. We want to test different cutoffs for this score and see how the results change under different default rate stress scenarios for the newly approved population (`swap-ins`).

```{r example-tradeoff, message=FALSE, warning=FALSE}
# Define a base policy. Stages and stresses will be added dynamically.
base_policy <- credit_policy(
  applicant_id_col = "id",
  score_cols = c("old_score", "new_score"),
  current_approval_col = "approved",
  actual_default_col = "defaulted",
  risk_level_col = "new_score_decile"
)

# Define the parameters we want to vary in our simulations
vary_params <- list(
  new_score_cutoff = seq(500, 750, by = 25),
  aggravation_factor = c(1.2, 1.5, 1.8)
)

# Run the analysis!
# This will run 11 (cutoffs) x 3 (factors) = 33 simulations.
tradeoff_results <- run_tradeoff_analysis(
  data = sample_data,
  base_policy = base_policy,
  vary_params = vary_params
)

head(tradeoff_results)
```

### 3. Visualize the Results

The output of the analysis is a tidy data frame, perfect for plotting with `ggplot2`. We can now visualize the "efficient frontier" showing the trade-off between approval rate and default rate for each stress scenario.

```{r example-plot}
tradeoff_results %>%
  mutate(Stress = paste0(round((aggravation_factor - 1) * 100), "% PD Aggravation")) %>%
  ggplot(aes(x = approval_rate, y = default_rate, color = Stress)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Efficient Frontier: Approval vs. Default Rate",
    subtitle = "Each line represents a different stress scenario for swap-in defaults",
    x = "Overall Approval Rate", 
    y = "Average Default Rate (Approved Population)"
  ) +
  scale_x_continuous(labels = scales::percent_format()) +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_minimal() +
  theme(legend.position = "bottom")
```
